<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Stock Chart Debug</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            margin: 0;
            padding: 10px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        
        #chart-container {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        #loading, #debug {
            text-align: center;
            padding: 10px;
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
        }
        
        #debug {
            background: #f0f0f0;
			padding: 0;
            border-radius: 4px;
        }
        
        .ticker-info {
            margin-bottom: 15px;
            padding: 10px;
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="ticker-info">
        <span id="ticker-display">Loading...</span>
    </div>
    
    <div id="debug"></div>
    <div id="loading">Loading chart data...</div>
    <div id="chart-container"></div>

        <script>
        document.addEventListener('DOMContentLoaded', function () {
            const tg = window.Telegram?.WebApp || { expand: () => {}, themeParams: {} };
            tg.expand();
            
            const chartContainer = document.getElementById('chart-container');
            const loadingDiv = document.getElementById('loading');
            const tickerDisplay = document.getElementById('ticker-display');
            
            const urlParams = new URLSearchParams(window.location.search);
            const ticker = urlParams.get('ticker') || 'AAPL';
            const apiKey = 'T8XRRD15SJUJ2QZM'; 
            
            tickerDisplay.textContent = `${ticker} - 5min Chart`;
            
            const chartOptions = {
                layout: {
                    background: { color: tg.themeParams.bg_color || '#ffffff' },
                    textColor: tg.themeParams.text_color || '#182233',
                },
                grid: {
                    vertLines: { color: tg.themeParams.secondary_bg_color || '#e1ecf7' },
                    horzLines: { color: tg.themeParams.secondary_bg_color || '#e1ecf7' },
                },
                timeScale: {
                    timeVisible: true,
                    secondsVisible: false,
                },
                width: chartContainer.clientWidth,
                height: 400,
            };
            
            const chart = LightweightCharts.createChart(chartContainer, chartOptions);
            const series = chart.addCandlestickSeries({
                upColor: '#26a69a',
                downColor: '#ef5350',
                borderDownColor: '#ef5350',
                borderUpColor: '#26a69a',
                wickDownColor: '#26a69a',
                wickUpColor: '#ef5350',
            });
                
            async function loadChartData() {
                try {                  
                    const response = await fetch(`https://www.alphavantage.co/query?function=TIME_SERIES_INTRADAY&symbol=${ticker}&interval=5min&outputsize=full&apikey=${apiKey}`);
                    const data = await response.json();
                    
                    if (data['Error Message'] || data['Note']) {
                        throw new Error(data['Error Message'] || data['Note']);
                    }
                    
                    const timeSeries = data['Time Series (5min)'];
                    if (!timeSeries) throw new Error('No data available');
                    
                    const chartData = Object.keys(timeSeries)
                        .map(timestamp => {
                            const candle = timeSeries[timestamp];
                            return {                              
                                time: new Date(timestamp).getTime() / 1000,
                                open: parseFloat(candle['1. open']),
                                high: parseFloat(candle['2. high']),
                                low: parseFloat(candle['3. low']),
                                close: parseFloat(candle['4. close']),
                            };
                        })
                        .reverse(); 
                    
                    series.setData(chartData);
                    chart.timeScale().fitContent();
                    loadingDiv.style.display = 'none';
                    
                } catch (error) {
                    loadingDiv.textContent = `Error: ${error.message}`;
                    console.error(error);
                }
            }
            
            window.addEventListener('resize', () => {
                chart.applyOptions({ width: chartContainer.clientWidth });
            });
            
            loadChartData();
        });
    </script>
</body>
</html>
